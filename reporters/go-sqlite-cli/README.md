# IBM webMethods License Monitor - Reporter CLI

A command-line tool for aggregating and reporting IBM webMethods license metrics from inspector data.

## Overview

The `go-sqlite-cli` reporter is a centralized reporting application that:

- Aggregates CSV output files from multiple inspector nodes
- Stores license monitoring data in a SQLite database
- Generates compliance reports for license auditing
- Tracks physical host relationships for proper VM license aggregation
- Provides multiple output formats (table, CSV, JSON)

## Quick Start

### 1. Initialize Database

Create a new database with the complete schema:

```bash
./seed-go-sqlite-api-static init --db-path ./data/license-monitor.db
```

This creates all required tables:
- `license_terms` - IBM license terms and programs
- `product_codes` - Product mappings to license terms
- `landscape_nodes` - Nodes in your landscape
- `physical_hosts` - Physical hosts for VM aggregation
- `measurements` - System inspection results
- `detected_products` - Product detection results
- `import_sessions` - Import audit trail

### 2. Import Inspector Data

Import CSV files generated by the inspector:

```bash
# Import a single file
./seed-go-sqlite-api-static import --db-path ./data/license-monitor.db \
  --file ./iwdli_output_host1_20251022_090906.csv

# Import all files in a directory
./seed-go-sqlite-api-static import --db-path ./data/license-monitor.db \
  --dir ./input/

# Import with reference data (first time only)
./seed-go-sqlite-api-static import --db-path ./data/license-monitor.db \
  --load-reference \
  --product-codes ./product-codes.csv \
  --file ./iwdli_output_host1_20251022_090906.csv
```

### 3. Generate Reports

View license compliance data:

```bash
# Daily product summary
./seed-go-sqlite-api-static report daily-summary --db-path ./data/license-monitor.db

# Host detail report
./seed-go-sqlite-api-static report host-detail --db-path ./data/license-monitor.db

# Core aggregation by product
./seed-go-sqlite-api-static report cores --db-path ./data/license-monitor.db
```

## Commands

### `init` - Initialize Database

Creates a new SQLite database with the complete schema.

**Usage:**
```bash
./seed-go-sqlite-api-static init [flags]
```

**Flags:**
- `--db-path <path>` - Path to the SQLite database file (default: "data/license-monitor.db")

**Example:**
```bash
./seed-go-sqlite-api-static init --db-path ./data/license-monitor.db
```

**Output:**
```
Initializing database at: ./data/license-monitor.db
Creating database schema...
Verifying schema...

Success! Database initialized.
  Location: ./data/license-monitor.db
  Schema version: 1.0.0

Database ready for import operations.

Next steps:
  1. Import inspector CSV files: go-sqlite-cli import --file <csv-file>
  2. Generate reports: go-sqlite-cli report --help
```

---

### `import` - Import Inspector Data

Import CSV files generated by the inspector into the database.

**Usage:**
```bash
./seed-go-sqlite-api-static import [flags]
```

**Import Modes:**

1. **Single File Import** - Import one CSV file
2. **Directory Import** - Import all CSV files in a directory (no file movement)
3. **Folder Workflow** - Process files from input directory with automatic movement to processed/discards

**Flags:**
- `--db-path <path>` - Path to the SQLite database file (default: "data/license-monitor.db")
- `--file <path>` - Path to a single CSV file to import
- `--dir <path>` - Directory containing CSV files to import (no file movement)
- `--input-dir <path>` - Input directory for folder-based workflow (files moved after processing)
- `--processed-dir <path>` - Processed files directory (default: <parent>/processed)
- `--discards-dir <path>` - Discarded files directory (default: <parent>/discards)
- `--load-reference` - Load reference data (product codes) before importing
- `--product-codes <path>` - Path to product-codes.csv file (required with --load-reference)

**Examples:**

**Single File Import:**
```bash
./seed-go-sqlite-api-static import \
  --db-path ./data/license-monitor.db \
  --file ./iwdli_output_omis446_20251021_090906.csv
```

**Directory Import (all CSV files):**
```bash
./seed-go-sqlite-api-static import \
  --db-path ./data/license-monitor.db \
  --dir ./input/
```

**Folder Workflow (with automatic file movement):**
```bash
./seed-go-sqlite-api-static import \
  --db-path ./data/license-monitor.db \
  --input-dir ./test-data/input
```
Files are automatically moved to:
- `./test-data/processed/` on success
- `./test-data/discards/` on error

**First Import with Reference Data:**
```bash
./seed-go-sqlite-api-static import \
  --db-path ./data/license-monitor.db \
  --load-reference \
  --product-codes ./product-codes.csv \
  --file ./iwdli_output_host1_20251022_090906.csv
```

**Output:**
```
Importing 1 file(s) into database: ./data/license-monitor.db

[1/1] Importing: iwdli_output_omis446_20251021_090906.csv
  Session ID: import-20251022-143025-abc123
  Records created: 25
  Records updated: 0

Import Summary:
  Files processed: 1
  Total records created: 25
  Total records updated: 0
  Total records skipped: 0

Next steps:
  - Generate reports: go-sqlite-cli report --help
  - Query data: sqlite3 ./data/license-monitor.db
```

**Features:**
- **Automatic node creation** - Creates landscape_nodes entries if not exists
- **Physical host tracking** - Tracks physical hosts for VM aggregation
- **Idempotent imports** - Safe to re-import same data (upsert on duplicate)
- **Import audit trail** - Tracks all imports in import_sessions table
- **Error handling** - Validates data and reports errors

---

### `report` - Generate Reports

Generate license compliance reports from the database.

#### Available Report Types

1. **daily-summary** - Daily product summary across all nodes
2. **host-detail** - Detailed host-level information
3. **cores** - Core aggregation by product

**Global Report Flags:**
- `--db-path <path>` - Path to the SQLite database file (default: "data/license-monitor.db")
- `--format <type>` - Output format: table, csv, json (default: "table")
- `--output <file>` - Output file (default: stdout)
- `--product <code>` - Filter by product code
- `--from <date>` - Filter from date (YYYY-MM-DD format)
- `--to <date>` - Filter to date (YYYY-MM-DD format)

---

### `report daily-summary`

Shows daily summary of running and installed products with core counts.

**Usage:**
```bash
./seed-go-sqlite-api-static report daily-summary [flags]
```

**Output Columns:**
- `date` - Measurement date
- `product` - Product code
- `product_name` - Full product name
- `mode` - PROD or NON PROD
- `term_id` - IBM license term ID
- `program` - IBM program number
- `running_nodes` - Count of nodes with product running
- `running_vcores` - Virtual cores for running products
- `running_phys_direct` - Physical cores (non-virtualized)
- `running_phys_hosts` - Unique physical hosts
- `running_phys_from_hosts` - Physical cores from hosts (deduplicated)
- `installs` - Total installation count
- `installed_nodes` - Count of nodes with product installed
- `installed_vcores` - Virtual cores for installed products
- `installed_phys_direct` - Physical cores (non-virtualized)
- `installed_phys_hosts` - Unique physical hosts
- `installed_phys_from_hosts` - Physical cores from hosts (deduplicated)

**Examples:**

**Table Format (default):**
```bash
./seed-go-sqlite-api-static report daily-summary --db-path ./data/license-monitor.db
```

Output:
```
Daily Product Summary Report
==============================================================================

Date        Product      Mode      Program   Running  Installs  vCores  pCores
----        -------      ----      -------   -------  --------  ------  ------
2025-10-21  IS_ONP_PRD   PROD      5900-BGP  5        12        80      192
2025-10-21  IS_ONP_NPR   NON PROD  5900-BGQ  8        24        96      256
2025-10-21  BRK_ONP_PRD  PROD      5900-BGP  3        7         48      144

Total rows: 3
```

**CSV Export:**
```bash
./seed-go-sqlite-api-static report daily-summary \
  --db-path ./data/license-monitor.db \
  --format csv \
  --output daily-summary-report.csv
```

**Filtered by Product:**
```bash
./seed-go-sqlite-api-static report daily-summary \
  --db-path ./data/license-monitor.db \
  --product IS_ONP_PRD
```

**Date Range Filter:**
```bash
./seed-go-sqlite-api-static report daily-summary \
  --db-path ./data/license-monitor.db \
  --from 2025-10-01 \
  --to 2025-10-31
```

**JSON Format:**
```bash
./seed-go-sqlite-api-static report daily-summary \
  --db-path ./data/license-monitor.db \
  --format json
```

---

### `report host-detail`

Shows detailed information for each host including product detection, system details, virtualization status, and eligibility flags.

**Usage:**
```bash
./seed-go-sqlite-api-static report host-detail [flags]
```

**Additional Flags:**
- `--host <fqdn>` - Filter by host FQDN (supports wildcards)

**Output Columns:**
- `host_fqdn` - Fully qualified domain name
- `date` - Detection date
- `virtual` - Virtualization status (true/false)
- `product_code` - Product mnemonic code
- `running` - Whether product is running (true/false)
- `installed` - Whether product is installed (true/false)
- `virtual_cpus` - Number of virtual CPUs
- `physical_host_id` - ID of physical host (NULL for physical hosts)
- `physical_cpus` - Number of physical CPUs (NULL if not applicable)
- `operating_system` - OS name and version
- `eligible_os` - OS eligibility (true/false)
- `eligible_virtualization` - Virtualization eligibility (true/false)

**Examples:**

**All Hosts:**
```bash
./seed-go-sqlite-api-static report host-detail --db-path ./data/license-monitor.db
```

Output:
```
Host Detail Report
==========================================================================================================

Host FQDN  Date        Virt   Product      Run    Inst   vCPUs  Physical Host             pCPUs  OS         OS Elig  Virt Elig
--------   ----        ----   -------      ---    ----   -----  -------------             -----  --         -------  ---------
i8.local   2025-10-21  true   BRK_ONP_PRD  false  false  16     aix-machine-00FAF22C4C00  48     AIX 7.200  true     true
i9.local   2025-10-21  true   IS_ONP_PRD   false  false  2      aix-machine-00FAF22F4C00  48     AIX 6.100  false    false
o6.local   2025-10-21  false  BRK_ONP_PRD  true   true   16     o6                        N/A    Solaris 8  true     false

Total rows: 161
```

**Specific Host:**
```bash
./seed-go-sqlite-api-static report host-detail \
  --db-path ./data/license-monitor.db \
  --host i9.local
```

**Host and Product Filter:**
```bash
./seed-go-sqlite-api-static report host-detail \
  --db-path ./data/license-monitor.db \
  --host i9.local \
  --product IS_ONP_PRD
```

**CSV Export:**
```bash
./seed-go-sqlite-api-static report host-detail \
  --db-path ./data/license-monitor.db \
  --host o6.local \
  --format csv \
  --output host-detail.csv
```

**JSON with Date Range:**
```bash
./seed-go-sqlite-api-static report host-detail \
  --db-path ./data/license-monitor.db \
  --host i8.local \
  --product BRK_ONP_PRD \
  --from 2025-10-21 \
  --to 2025-10-21 \
  --format json
```

**Use Cases:**
- Host inspection and configuration review
- Virtual machine deployment analysis
- Product distribution across landscape
- Eligibility audits (OS and virtualization)
- Physical host to VM mapping
- Capacity planning and CPU allocation analysis

---

### `report cores`

Shows core counts aggregated by product with eligibility breakdown.

**Usage:**
```bash
./seed-go-sqlite-api-static report cores [flags]
```

**Output Columns:**
- `product_code` - Product mnemonic code
- `product_name` - Full product name
- `measurement_date` - Date of measurement
- `total_cores` - Total cores detected
- `licensed_cores` - Cores eligible for licensing
- `unlicensed_cores` - Cores not eligible
- `non_prod_cores` - Non-production cores
- `third_party_cores` - Third-party virtualization cores

**Examples:**

**All Products:**
```bash
./seed-go-sqlite-api-static report cores --db-path ./data/license-monitor.db
```

**Filtered by Product:**
```bash
./seed-go-sqlite-api-static report cores \
  --db-path ./data/license-monitor.db \
  --product IS_ONP_PRD
```

**CSV Export:**
```bash
./seed-go-sqlite-api-static report cores \
  --db-path ./data/license-monitor.db \
  --format csv \
  --output core-aggregation.csv
```

---

## Database Schema

The reporter uses the following main tables:

### Reference Data Tables

**license_terms**
- Stores IBM license terms and program information
- Primary key: `term_id` (e.g., "L-USRQ-RKUUCN")

**product_codes**
- Maps product codes to IBM product codes and license terms
- Primary key: `product_mnemo_code` (e.g., "IS_ONP_PRD")
- Links to: `license_terms`

**landscape_nodes**
- Inventory of nodes in the landscape
- Primary key: `main_fqdn`

### Measurement Data Tables

**measurements**
- System inspection results from each node
- Primary key: (`main_fqdn`, `detection_timestamp`)
- Contains: OS info, CPU counts, virtualization details, eligibility flags

**detected_products**
- Products detected on each node
- Primary key: (`main_fqdn`, `product_mnemo_code`, `detection_timestamp`)
- Status: "present" (running/installed) or "absent"

**physical_hosts**
- Tracks physical hosts for VM aggregation
- Primary key: `physical_host_id`
- Contains: host identification method, confidence level, CPU counts

**import_sessions**
- Audit trail of all import operations
- Primary key: `session_id`
- Contains: source file, timestamp, record counts, status

### Views

The reporter includes several pre-built views for reporting:

- `v_latest_measurements` - Most recent measurement for each node
- `v_core_aggregation_by_product` - Core counts per product with eligibility breakdown
- `v_daily_product_summary` - Daily rollup of products across all nodes
- `v_host_detail` - Detailed host-level information

---

## Physical Host Aggregation

When multiple virtual machines run on the same physical host, the reporter properly aggregates license metrics:

**Aggregation Rules:**
1. VMs with same `physical_host_id` are recognized as running on the same physical host
2. Physical host CPU cores are counted only once (not summed across VMs)
3. High-confidence host IDs are aggregated automatically
4. Low-confidence host IDs may be flagged for manual review

**Example Scenario:**

```
VM1: physical_host_id=HOST123, host_physical_cpus=16, considered_cpus=4
VM2: physical_host_id=HOST123, host_physical_cpus=16, considered_cpus=8

Result: Count 16 physical CPUs once (not 4+8=12)
```

This ensures accurate license compliance calculation for virtualized environments.

---

## Folder-Based Workflow

The reporter supports an automated folder-based workflow for continuous data collection:

**Setup:**
```
./input/           <- Place new inspector CSV files here
./processed/       <- Successfully imported files moved here
./discards/        <- Failed imports moved here
```

**Usage:**
```bash
./seed-go-sqlite-api-static import \
  --db-path ./data/license-monitor.db \
  --input-dir ./input
```

**Workflow:**
1. Inspector nodes generate CSV files
2. Files are transferred to input directory (via cron, file transfer, etc.)
3. Reporter processes files from input directory
4. On success: file moved to processed directory
5. On error: file moved to discards directory

This enables automated, unattended license data collection.

---

## Output Formats

All reports support three output formats:

### Table Format (default)

Human-readable tabular output with aligned columns.

```bash
./seed-go-sqlite-api-static report daily-summary --format table
```

### CSV Format

Machine-readable CSV for import into spreadsheets or other tools.

```bash
./seed-go-sqlite-api-static report daily-summary --format csv --output report.csv
```

### JSON Format

Structured JSON for programmatic consumption.

```bash
./seed-go-sqlite-api-static report daily-summary --format json --output report.json
```

---

## Building from Source

**Prerequisites:**
- Go 1.24 or later
- GCC (for CGO SQLite compilation)
- Make

**Build Commands:**

```bash
# Development build (current platform)
make build

# Static binary for containers (Linux amd64)
make build-static

# Multi-platform builds
make build-all

# Build with tests
make test-all

# Clean build artifacts
make clean
```

**Build Targets:**
- Development binary: `target/bin/seed-go-sqlite-api`
- Static binary: `target/bin/seed-go-sqlite-api-static`
- Production binary: `target/bin/seed-go-sqlite-api-linux-amd64`

**Note for AIX:** Due to CGO dependencies, AIX builds require native compilation on an AIX system. Run `make build-aix-info` for details.

---

## Acceptance Testing

The reporter includes comprehensive acceptance tests that validate end-to-end functionality.

**Run Tests:**
```bash
# Build static binary first
make build-static

# Run acceptance tests
make acceptance-test

# Run all tests (unit + acceptance)
make test-all
```

**Test Coverage:**
- Database initialization
- Reference data loading
- Single and multiple file imports
- Physical host tracking
- Detected products tracking
- Report generation

Test fixtures and expected outputs are in `acceptance-test/fixtures/` and `acceptance-test/expected-output/`.

---

## Typical Workflow

### 1. Initial Setup

```bash
# Build the reporter
cd reporters/go-sqlite-cli
make build-static

# Initialize database
./target/bin/seed-go-sqlite-api-static init --db-path ./data/license-monitor.db

# Load reference data (product codes)
./target/bin/seed-go-sqlite-api-static import \
  --db-path ./data/license-monitor.db \
  --load-reference \
  --product-codes ../../inspectors/default/landscape-config/product-codes.csv \
  --file ./first-inspector-file.csv
```

### 2. Regular Data Collection

```bash
# Import inspector data from multiple nodes
./target/bin/seed-go-sqlite-api-static import \
  --db-path ./data/license-monitor.db \
  --dir ./input/
```

### 3. Generate Reports

```bash
# Daily summary
./target/bin/seed-go-sqlite-api-static report daily-summary \
  --db-path ./data/license-monitor.db \
  --from 2025-10-01 \
  --to 2025-10-31 \
  --format csv \
  --output monthly-summary.csv

# Host details
./target/bin/seed-go-sqlite-api-static report host-detail \
  --db-path ./data/license-monitor.db \
  --format csv \
  --output host-inventory.csv
```

### 4. Scheduled Execution

Set up cron jobs for automated processing:

```bash
# Import new inspector data daily at 2 AM
0 2 * * * /opt/license-monitor/bin/seed-go-sqlite-api-static import \
  --db-path /var/data/license-monitor.db \
  --input-dir /var/data/inspector-input

# Generate weekly report on Monday at 8 AM
0 8 * * 1 /opt/license-monitor/bin/seed-go-sqlite-api-static report daily-summary \
  --db-path /var/data/license-monitor.db \
  --from $(date -d '7 days ago' +%Y-%m-%d) \
  --to $(date +%Y-%m-%d) \
  --format csv \
  --output /var/reports/weekly-license-report.csv
```

---

## Troubleshooting

### Database doesn't exist error

```
Error: database does not exist at ./data/license-monitor.db
Run 'go-sqlite-cli init' first
```

**Solution:** Initialize the database first with `init` command.

### Binary not found

```
Error: Binary not found at target/bin/seed-go-sqlite-api-static
```

**Solution:** Build the binary first with `make build-static`.

### Import fails with foreign key constraint

```
Error: FOREIGN KEY constraint failed
```

**Solution:** Load reference data first with `--load-reference` and `--product-codes` flags.

### No data in reports

```
No data found matching the criteria
```

**Solution:** 
1. Verify data was imported successfully
2. Check date filters match your data
3. Query database directly: `sqlite3 data/license-monitor.db "SELECT COUNT(*) FROM measurements;"`

### Multiple timestamps same day

The reporter automatically handles multiple measurements per day by using the latest timestamp. This ensures accurate daily aggregations.

---

## Database Queries

You can query the database directly using sqlite3:

```bash
# Connect to database
sqlite3 data/license-monitor.db

# View all tables
.tables

# Check imported data
SELECT COUNT(*) FROM measurements;
SELECT COUNT(*) FROM detected_products;
SELECT COUNT(DISTINCT main_fqdn) FROM measurements;

# View latest measurements
SELECT * FROM v_latest_measurements;

# Check physical host tracking
SELECT physical_host_id, COUNT(*) as vm_count 
FROM measurements 
WHERE physical_host_id != '' AND physical_host_id != 'unknown'
GROUP BY physical_host_id;

# View import history
SELECT * FROM import_sessions ORDER BY imported_at DESC LIMIT 10;
```

---

## License

Copyright 2025 Mihai Ungureanu, IBM Corporation

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.

---

## Related Documentation

- **Project Requirements**: See `../../REQUIREMENTS.md` for overall system architecture
- **Inspector Documentation**: See `../../inspectors/default/README.md` for inspector usage
- **Acceptance Tests**: See `acceptance-test/README.md` for testing details
- **Host Detail Command**: See `HOST_DETAIL_COMMAND.md` for detailed command reference
